<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Screen capture demo</title>
  </head>
  <body>
    <p><input id='record' type='button' value='start'/></p>
    <p><input id='stop' type='button' value='stop'/></p>
    <!-- Even if we are only concerned about the audio, we still need to use the video tag. -->
    <video autoplay></video>
    <script type = "text/javascript">
      let axios = require("axios");
      var video = document.querySelector('video')
      var chunks = [];
      var mediaRecorder;
      function errorCallback(e) {
        console.log('Error', e)
      }
      recordButton = document.getElementById('record');
      stopButton = document.getElementById('stop');
      navigator.getUserMedia({video: false, audio: true}, (localMediaStream) => {
        var video = document.querySelector('video')
        video.src = window.URL.createObjectURL(localMediaStream)
        video.onloadedmetadata = (e) => {
          mediaRecorder = new MediaRecorder(localMediaStream);
          mediaRecorder.ondataavailable = e => chunks.push(e.data);
          mediaRecorder.onstop = function(e) {
            var blob = new Blob(chunks, { 'type' : 'audio/wav' });

            var fileReader = new FileReader();
            let arrayBuffer;

            fileReader.onloadend = () => {
                arrayBuffer = fileReader.result;
                console.log(arrayBuffer);
                
                var formData = new FormData();
                formData.append('audio_data', blob);
                formData.append('audio_name', 'test.wav');
                axios.post('http://127.0.0.1:5000/upload', formData, {
                  headers: {
                    'Content-Type': 'multipart/form-data'
                  }
                })
            };
            fileReader.readAsArrayBuffer(blob);

            console.log(blob);
            chunks = [];
            var audioURL = URL.createObjectURL(blob);
            const audio = new Audio(audioURL);
            audio.play();
          }
          recordButton.onclick = function(e) {
            console.log('starting to record');
            mediaRecorder.start();
          }
          stopButton.onclick = function(e) {
            console.log('stopping the recording');
            mediaRecorder.stop();
          }
        };
      }, errorCallback);
    </script>
  </body>
</html>
